"use strict";var tabito=(()=>{var w=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var z=(n,t)=>{for(var r in t)w(n,r,{get:t[r],enumerable:!0})},N=(n,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of W(t))!Y.call(n,i)&&i!==r&&w(n,i,{get:()=>t[i],enumerable:!(e=q(t,i))||e.enumerable});return n};var C=n=>N(w({},"__esModule",{value:!0}),n);var Z={};z(Z,{_findGreedyPath:()=>F,addSynonym:()=>_,chunkInput:()=>X,sentenceToGraph:()=>Q});function h(n,t,r,e=!1){t in n||(n[t]=[]),(!e||!n[t].includes(r))&&n[t].push(r)}function $(n){let t={};for(let r in n)for(let e of n[r])h(t,e,r);return t}function S(n){let t={};for(let r in n)for(let e of n[r]){if(e in t)throw new Error("non-unique values");t[e]=r}return t}function G(n,t){let r=[],e=-1;for(;(e=n.indexOf(t,e+1))>=0;)r.push(e);return r}function T(n,t){if(n.length===0)throw new Error("empty");let r=n[0],e=t(r);for(let i of n){let s=t(i);s>e&&(e=s,r=i)}return r}function E(n,t){return typeof n==typeof t&&(typeof n=="string"?n===t:n.rt===t.rt)}function y(n){return n.map(t=>typeof t=="string"?t:t.ruby).join("")}function b(n,t){let r=n.indexOf(t);return r>=0&&n.indexOf(t,r+1)<0}function*K(n,t){let r=Math.min(n.length,t.length);for(let e=0;e<r;++e)yield[n[e],t[e]]}function*R(n,t){for(let r=n.length-1,e=t.length-1;r>=0&&e>=0;--r,--e)yield[n[r],t[e]]}var v="\u3041\u3042\u3043\u3044\u3045\u3046\u3047\u3048\u3049\u304A\u304B\u304C\u304D\u304E\u304F\u3050\u3051\u3052\u3053\u3054\u3055\u3056\u3057\u3058\u3059\u305A\u305B\u305C\u305D\u305E\u305F\u3060\u3061\u3062\u3063\u3064\u3065\u3066\u3067\u3068\u3069\u306A\u306B\u306C\u306D\u306E\u306F\u3070\u3071\u3072\u3073\u3074\u3075\u3076\u3077\u3078\u3079\u307A\u307B\u307C\u307E\u307F\u3080\u3081\u3082\u3083\u3084\u3085\u3086\u3087\u3088\u3089\u308A\u308B\u308C\u308D\u308E\u308F\u3090\u3091\u3092\u3093\u3094\u3095\u3096",k="\u30A1\u30A2\u30A3\u30A4\u30A5\u30A6\u30A7\u30A8\u30A9\u30AA\u30AB\u30AC\u30AD\u30AE\u30AF\u30B0\u30B1\u30B2\u30B3\u30B4\u30B5\u30B6\u30B7\u30B8\u30B9\u30BA\u30BB\u30BC\u30BD\u30BE\u30BF\u30C0\u30C1\u30C2\u30C3\u30C4\u30C5\u30C6\u30C7\u30C8\u30C9\u30CA\u30CB\u30CC\u30CD\u30CE\u30CF\u30D0\u30D1\u30D2\u30D3\u30D4\u30D5\u30D6\u30D7\u30D8\u30D9\u30DA\u30DB\u30DC\u30DE\u30DF\u30E0\u30E1\u30E2\u30E3\u30E4\u30E5\u30E6\u30E7\u30E8\u30E9\u30EA\u30EB\u30EC\u30ED\u30EE\u30EF\u30F0\u30F1\u30F2\u30F3\u30F4\u30F5\u30F6";if(v.length!==k.length)throw new Error("Kana strings not same length?");var j=new Map([]),D=new Map([]);v.split("").forEach((n,t)=>{j.set(k[t],n),D.set(n,k[t])});function x(n){return n.split("").map(t=>j.get(t)||t).join("")}function H(n,{textToKeys:t}){if(!n)return;let r=[];for(let e in t)n.startsWith(x(e))&&r.push(e);return r}function F(n,t){let r=x(n);return((H(r,t)??[]).flatMap(s=>t.textToKeys[s])??[]).map(s=>{let o=P(n,s,t);return{result:o.text,start:t.ancestorKeys[s]||!1,end:!!o.end}})}function P(n,t,r){if(!n)return{text:n};let{keyToNext:e,keyToText:i}=r,s=i[t],o=x(s),f=x(n);if(!f.startsWith(o))throw new Error("bad startKey");let g=e[t]?.filter(p=>f.startsWith(o+x(i[p])))??[],a=n.slice(0,s.length);if(g.length===0)return{text:a,end:!!r.leafKeys[t]};let u=n.slice(s.length),m=g.map(p=>P(u,p,r)),c=T(m,p=>p.text.length);return{text:a+c.text,end:c.end}}function X(n,t){let r=[],e=n;for(;e;){let i=F(e,t);if(i.length===0)r.push({text:e[0],status:"unknown",start:!1,full:!1}),e=e.slice(1);else{let s=T(i,o=>o.result.length);r.push({text:s.result,status:"ok",start:s.start,full:s.start&&s.end}),e=e.slice(s.result.length)}}return r}function _(n,t){let r=n.furigana,e=y(r),i=y(t),s=0;for(let[a,u]of K(r,t))if(E(a,u)){let m=y(r.slice(s+1)),c=y(t.slice(s+1));m&&c&&b(e,m)&&b(i,c)&&s++}else break;r=r.slice(s),t=t.slice(s);let o=0;for(let[a,u]of R(r,t))if(E(a,u)){let m=y(r.slice(0,o-1)),c=y(t.slice(0,o-1));m&&c&&b(e,m)&&b(i,c)&&o--}else break;r=r.slice(0,o||void 0),t=t.slice(0,o||void 0);let f=y(r),g=M(t);return g===M(r)||n.synonyms&&n.synonyms.some(([a,u])=>g===M(u)&&f===a)?n:{...n,synonyms:(n.synonyms??[]).concat([[f,t]])}}function M(n){return n.map(t=>typeof t=="string"?t:`${t.rt}${t.ruby}`).join("")}function B(n){let t=n.furigana.map(i=>typeof i=="string"?i:i.ruby),r=t.join(""),e=t.flatMap((i,s)=>Array.from({length:i.length},()=>s));for(let[i]of n.synonyms??[]){let s=r.indexOf(i);if(s<0)return!1;let o=s+i.length-1;if(s>0&&e[s]===e[s-1]||o<r.length-1&&e[o]===e[o+1])return!1}return!0}function L(n,t,r){let e=n.furigana.map(o=>typeof o=="string"?o:o.ruby),i=e.join(""),s=e.flatMap((o,f)=>Array.from({length:o.length},()=>f));for(let[o,f]of n.synonyms??[]){let g=G(i,o);if(g.length===0)throw new Error("synonym not found in raw sentence? "+o);for(let a of g){let u=a+o.length-1,m=s[a],c=s[u],p=O(n,m).flatMap(l=>r[l]??[]);for(let[l,d]of f.entries())p=U({f:d,fidx:`${o}/${a}/${l}`,previousKeys:p,textToKeys:t,keyToPrev:r});if(n.furigana[c+1])for(let l of O(n,c+1))for(let d of p)h(r,l,d);let I=O(n,c),A=Object.entries(r).filter(([,l])=>I.some(d=>l.includes(d))).map(([l])=>l);for(let l of A)for(let d of p)h(r,l,d,J)}}}var J=!0;function O(n,t){if(t<0||t>=n.furigana.length)throw new Error("weird index");let r=n.furigana[t];return typeof r=="string"?[`${r}/${t}`]:[`${r.rt}/${t}`,`${r.ruby}/${t}`]}function U({f:n,fidx:t,previousKeys:r,textToKeys:e,keyToPrev:i}){if(typeof n=="string"){let o=`${n}/${t}`;h(e,n,o);for(let f of r)h(i,o,f);return[o]}let s=[];{let o=`${n.ruby}/${t}`;h(e,n.ruby,o);for(let f of r)h(i,o,f);s.push(o)}{let o=`${n.rt}/${t}`;h(e,n.rt,o);for(let f of r)h(i,o,f);s.push(o)}return s}function Q(n){if(!B(n))throw new Error("Invalid synonyms");let t={},r={},e=[];for(let[a,u]of n.furigana.entries())e=U({f:u,fidx:a,previousKeys:e,textToKeys:t,keyToPrev:r});L(n,t,r);let i=$(r),s=S(t),o=Object.keys(s),f=Object.fromEntries(o.filter(a=>!(a in r)||r[a].length===0).map(a=>[a,!0])),g=Object.fromEntries(o.filter(a=>!(a in i)||i[a].length===0).map(a=>[a,!0]));return{textToKeys:t,keyToPrev:r,keyToText:s,keyToNext:i,ancestorKeys:f,leafKeys:g}}return C(Z);})();
//# sourceMappingURL=tabito.min.js.map
