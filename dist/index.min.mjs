function h(n,t,r,e=!1){t in n||(n[t]=[]),(!e||!n[t].includes(r))&&n[t].push(r)}function M(n){let t={};for(let r in n)for(let e of n[r])h(t,e,r);return t}function O(n){let t={};for(let r in n)for(let e of n[r]){if(e in t)throw new Error("non-unique values");t[e]=r}return t}function $(n,t){let r=[],e=-1;for(;(e=n.indexOf(t,e+1))>=0;)r.push(e);return r}function w(n,t){if(n.length===0)throw new Error("empty");let r=n[0],e=t(r);for(let i of n){let o=t(i);o>e&&(e=o,r=i)}return r}function T(n,t){return typeof n==typeof t&&(typeof n=="string"?n===t:n.rt===t.rt)}function m(n){return n.map(t=>typeof t=="string"?t:t.ruby).join("")}function b(n,t){let r=n.indexOf(t);return r>=0&&n.indexOf(t,r+1)<0}function*S(n,t){let r=Math.min(n.length,t.length);for(let e=0;e<r;++e)yield[n[e],t[e]]}function*G(n,t){for(let r=n.length-1,e=t.length-1;r>=0&&e>=0;--r,--e)yield[n[r],t[e]]}var K="\u3041\u3042\u3043\u3044\u3045\u3046\u3047\u3048\u3049\u304A\u304B\u304C\u304D\u304E\u304F\u3050\u3051\u3052\u3053\u3054\u3055\u3056\u3057\u3058\u3059\u305A\u305B\u305C\u305D\u305E\u305F\u3060\u3061\u3062\u3063\u3064\u3065\u3066\u3067\u3068\u3069\u306A\u306B\u306C\u306D\u306E\u306F\u3070\u3071\u3072\u3073\u3074\u3075\u3076\u3077\u3078\u3079\u307A\u307B\u307C\u307E\u307F\u3080\u3081\u3082\u3083\u3084\u3085\u3086\u3087\u3088\u3089\u308A\u308B\u308C\u308D\u308E\u308F\u3090\u3091\u3092\u3093\u3094\u3095\u3096",F="\u30A1\u30A2\u30A3\u30A4\u30A5\u30A6\u30A7\u30A8\u30A9\u30AA\u30AB\u30AC\u30AD\u30AE\u30AF\u30B0\u30B1\u30B2\u30B3\u30B4\u30B5\u30B6\u30B7\u30B8\u30B9\u30BA\u30BB\u30BC\u30BD\u30BE\u30BF\u30C0\u30C1\u30C2\u30C3\u30C4\u30C5\u30C6\u30C7\u30C8\u30C9\u30CA\u30CB\u30CC\u30CD\u30CE\u30CF\u30D0\u30D1\u30D2\u30D3\u30D4\u30D5\u30D6\u30D7\u30D8\u30D9\u30DA\u30DB\u30DC\u30DE\u30DF\u30E0\u30E1\u30E2\u30E3\u30E4\u30E5\u30E6\u30E7\u30E8\u30E9\u30EA\u30EB\u30EC\u30ED\u30EE\u30EF\u30F0\u30F1\u30F2\u30F3\u30F4\u30F5\u30F6";if(K.length!==F.length)throw new Error("Kana strings not same length?");var R=new Map([]),U=new Map([]);K.split("").forEach((n,t)=>{R.set(F[t],n),U.set(n,F[t])});function x(n){return n.split("").map(t=>R.get(t)||t).join("")}function I(n,{textToKeys:t}){if(!n)return;let r=[];for(let e in t)n.startsWith(x(e))&&r.push(e);return r}function v(n,t){let r=x(n);return((I(r,t)??[]).flatMap(o=>t.textToKeys[o])??[]).map(o=>{let s=P(n,o,t);return{result:s.text,start:t.ancestorKeys[o]||!1,end:!!s.end}})}function P(n,t,r){if(!n)return{text:n};let{keyToNext:e,keyToText:i}=r,o=i[t],s=x(o),f=x(n);if(!f.startsWith(s))throw new Error("bad startKey");let u=e[t]?.filter(p=>f.startsWith(s+x(i[p])))??[],a=n.slice(0,o.length);if(u.length===0)return{text:a,end:!!r.leafKeys[t]};let l=n.slice(o.length),y=u.map(p=>P(l,p,r)),c=w(y,p=>p.text.length);return{text:a+c.text,end:c.end}}function q(n,t){let r=[],e=n;for(;e;){let i=v(e,t);if(i.length===0)r.push({text:e[0],status:"unknown",start:!1,full:!1}),e=e.slice(1);else{let o=w(i,s=>s.result.length);r.push({text:o.result,status:"ok",start:o.start,full:o.start&&o.end}),e=e.slice(o.result.length)}}return r}function J(n,t){let r=n.furigana,e=m(r),i=m(t),o=0;for(let[a,l]of S(r,t))if(T(a,l)){let y=m(r.slice(o+1)),c=m(t.slice(o+1));y&&c&&b(e,y)&&b(i,c)&&o++}else break;r=r.slice(o),t=t.slice(o);let s=0;for(let[a,l]of G(r,t))if(T(a,l)){let y=m(r.slice(0,s-1)),c=m(t.slice(0,s-1));y&&c&&b(e,y)&&b(i,c)&&s--}else break;r=r.slice(0,s||void 0),t=t.slice(0,s||void 0);let f=m(r),u=E(t);return u===E(r)||n.synonyms&&n.synonyms.some(([a,l])=>u===E(l)&&f===a)?n:{...n,synonyms:(n.synonyms??[]).concat([[f,t]])}}function E(n){return n.map(t=>typeof t=="string"?t:`${t.rt}${t.ruby}`).join("")}function V(n){let t=[n.furigana];if(!n.synonyms||n.synonyms.length===0)return t;let r=[];for(let i of n.furigana){r.push(i);let o=(typeof i=="string"?i.length:i.ruby.length)-1;o>=1&&r.push(...Array(o).fill(void 0))}let e=m(n.furigana);for(let[i,o]of n.synonyms){let s=W(e,i);for(let f of s){let u=r.slice();u.splice(f,i.length,...o),t.push(u.filter(a=>!!a))}}return t}function W(n,t){let r=[],e=0;for(;e>=0;)e=n.indexOf(t,e),e>=0&&(r.push(e),e+=t.length);return r}function Y(n){let t=n.furigana.map(i=>typeof i=="string"?i:i.ruby),r=t.join(""),e=t.flatMap((i,o)=>Array.from({length:i.length},()=>o));for(let[i]of n.synonyms??[]){let o=r.indexOf(i);if(o<0)return!1;let s=o+i.length-1;if(o>0&&e[o]===e[o-1]||s<r.length-1&&e[s]===e[s+1])return!1}return!0}function z(n,t,r){let e=n.furigana.map(s=>typeof s=="string"?s:s.ruby),i=e.join(""),o=e.flatMap((s,f)=>Array.from({length:s.length},()=>f));for(let[s,f]of n.synonyms??[]){let u=$(i,s);if(u.length===0)throw new Error("synonym not found in raw sentence? "+s);for(let a of u){let l=a+s.length-1,y=o[a],c=o[l],p=k(n,y).flatMap(g=>r[g]??[]);for(let[g,d]of f.entries())p=j({f:d,fidx:`${s}/${a}/${g}`,previousKeys:p,textToKeys:t,keyToPrev:r});if(n.furigana[c+1])for(let g of k(n,c+1))for(let d of p)h(r,g,d);let X=k(n,c),A=Object.entries(r).filter(([,g])=>X.some(d=>g.includes(d))).map(([g])=>g);for(let g of A)for(let d of p)h(r,g,d,N)}}}var N=!0;function k(n,t){if(t<0||t>=n.furigana.length)throw new Error("weird index");let r=n.furigana[t];return typeof r=="string"?[`${r}/${t}`]:[`${r.rt}/${t}`,`${r.ruby}/${t}`]}function j({f:n,fidx:t,previousKeys:r,textToKeys:e,keyToPrev:i}){if(typeof n=="string"){let s=`${n}/${t}`;h(e,n,s);for(let f of r)h(i,s,f);return[s]}let o=[];{let s=`${n.ruby}/${t}`;h(e,n.ruby,s);for(let f of r)h(i,s,f);o.push(s)}{let s=`${n.rt}/${t}`;h(e,n.rt,s);for(let f of r)h(i,s,f);o.push(s)}return o}function rt(n){if(!Y(n))throw new Error("Invalid synonyms");let t={},r={},e=[];for(let[a,l]of n.furigana.entries())e=j({f:l,fidx:a,previousKeys:e,textToKeys:t,keyToPrev:r});z(n,t,r);let i=M(r),o=O(t),s=Object.keys(o),f=Object.fromEntries(s.filter(a=>!(a in r)||r[a].length===0).map(a=>[a,!0])),u=Object.fromEntries(s.filter(a=>!(a in i)||i[a].length===0).map(a=>[a,!0]));return{textToKeys:t,keyToPrev:r,keyToText:o,keyToNext:i,ancestorKeys:f,leafKeys:u}}export{v as _findGreedyPath,J as addSynonym,q as chunkInput,V as enumerateAcceptable,rt as sentenceToGraph,Y as validateSynonyms};
//# sourceMappingURL=index.min.mjs.map
