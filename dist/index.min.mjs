function p(n,t,r,e=!1){t in n||(n[t]=[]),(!e||!n[t].includes(r))&&n[t].push(r)}function F(n){let t={};for(let r in n)for(let e of n[r])p(t,e,r);return t}function M(n){let t={};for(let r in n)for(let e of n[r]){if(e in t)throw new Error("non-unique values");t[e]=r}return t}function O(n,t){let r=[],e=-1;for(;(e=n.indexOf(t,e+1))>=0;)r.push(e);return r}function $(n,t){if(n.length===0)throw new Error("empty");let r=n[0],e=t(r);for(let i of n){let s=t(i);s>e&&(e=s,r=i)}return r}function K(n){if(n.length===0)throw new Error("empty");return n.reduce((t,r)=>r.length>t.length?r:t)}function w(n,t){return typeof n==typeof t&&(typeof n=="string"?n===t:n.rt===t.rt)}function m(n){return n.map(t=>typeof t=="string"?t:t.ruby).join("")}function x(n,t){let r=n.indexOf(t);return r>=0&&n.indexOf(t,r+1)<0}function*S(n,t){let r=Math.min(n.length,t.length);for(let e=0;e<r;++e)yield[n[e],t[e]]}function*G(n,t){for(let r=n.length-1,e=t.length-1;r>=0&&e>=0;--r,--e)yield[n[r],t[e]]}var R="\u3041\u3042\u3043\u3044\u3045\u3046\u3047\u3048\u3049\u304A\u304B\u304C\u304D\u304E\u304F\u3050\u3051\u3052\u3053\u3054\u3055\u3056\u3057\u3058\u3059\u305A\u305B\u305C\u305D\u305E\u305F\u3060\u3061\u3062\u3063\u3064\u3065\u3066\u3067\u3068\u3069\u306A\u306B\u306C\u306D\u306E\u306F\u3070\u3071\u3072\u3073\u3074\u3075\u3076\u3077\u3078\u3079\u307A\u307B\u307C\u307E\u307F\u3080\u3081\u3082\u3083\u3084\u3085\u3086\u3087\u3088\u3089\u308A\u308B\u308C\u308D\u308E\u308F\u3090\u3091\u3092\u3093\u3094\u3095\u3096",T="\u30A1\u30A2\u30A3\u30A4\u30A5\u30A6\u30A7\u30A8\u30A9\u30AA\u30AB\u30AC\u30AD\u30AE\u30AF\u30B0\u30B1\u30B2\u30B3\u30B4\u30B5\u30B6\u30B7\u30B8\u30B9\u30BA\u30BB\u30BC\u30BD\u30BE\u30BF\u30C0\u30C1\u30C2\u30C3\u30C4\u30C5\u30C6\u30C7\u30C8\u30C9\u30CA\u30CB\u30CC\u30CD\u30CE\u30CF\u30D0\u30D1\u30D2\u30D3\u30D4\u30D5\u30D6\u30D7\u30D8\u30D9\u30DA\u30DB\u30DC\u30DE\u30DF\u30E0\u30E1\u30E2\u30E3\u30E4\u30E5\u30E6\u30E7\u30E8\u30E9\u30EA\u30EB\u30EC\u30ED\u30EE\u30EF\u30F0\u30F1\u30F2\u30F3\u30F4\u30F5\u30F6";if(R.length!==T.length)throw new Error("Kana strings not same length?");var j=new Map([]),A=new Map([]);R.split("").forEach((n,t)=>{j.set(T[t],n),A.set(n,T[t])});function d(n){return n.split("").map(t=>j.get(t)||t).join("")}function q(n,{textToKeys:t}){if(!n)return;let r=[];for(let e in t)n.startsWith(d(e))&&r.push(e);return r}function P(n,t){let r=d(n);return((q(r,t)??[]).flatMap(s=>t.textToKeys[s])??[]).map(s=>({firstKey:s,result:X(n,s,t)}))}function X(n,t,r){if(!n)return n;let{keyToNext:e,keyToText:i}=r,s=i[t],o=d(s),f=d(n);if(!f.startsWith(o))throw new Error("bad startKey");let l=e[t]?.filter(c=>f.startsWith(o+d(i[c])))??[],a=n.slice(0,s.length);if(l.length===0)return a;let u=n.slice(s.length),h=l.map(c=>X(u,c,r));return a+K(h)}function W(n,t){let r=[],e=n;for(;e;){let i=P(e,t);if(i.length===0)r.push({text:e[0],status:"unknown",start:!1}),e=e.slice(1);else{let s=$(i,o=>o.result.length);r.push({text:s.result,status:"ok",start:t.ancestorKeys[s.firstKey]||!1}),e=e.slice(s.result.length)}}return r}function J(n,t){let r=n.furigana,e=m(r),i=m(t),s=0;for(let[a,u]of S(r,t))if(w(a,u)){let h=m(r.slice(s+1)),c=m(t.slice(s+1));h&&c&&x(e,h)&&x(i,c)&&s++}else break;r=r.slice(s),t=t.slice(s);let o=0;for(let[a,u]of G(r,t))if(w(a,u)){let h=m(r.slice(0,o-1)),c=m(t.slice(0,o-1));h&&c&&x(e,h)&&x(i,c)&&o--}else break;r=r.slice(0,o||void 0),t=t.slice(0,o||void 0);let f=m(r),l=E(t);return l===E(r)||n.synonyms&&n.synonyms.some(([a,u])=>l===E(u)&&f===a)?n:{...n,synonyms:(n.synonyms??[]).concat([[f,t]])}}function E(n){return n.map(t=>typeof t=="string"?t:`${t.rt}${t.ruby}`).join("")}function Y(n){let t=n.furigana.map(i=>typeof i=="string"?i:i.ruby),r=t.join(""),e=t.flatMap((i,s)=>Array.from({length:i.length},()=>s));for(let[i]of n.synonyms??[]){let s=r.indexOf(i);if(s<0)return!1;let o=s+i.length-1;if(s>0&&e[s]===e[s-1]||o<r.length-1&&e[o]===e[o+1])return!1}return!0}function z(n,t,r){let e=n.furigana.map(o=>typeof o=="string"?o:o.ruby),i=e.join(""),s=e.flatMap((o,f)=>Array.from({length:o.length},()=>f));for(let[o,f]of n.synonyms??[]){let l=O(i,o);if(l.length===0)throw new Error("synonym not found in raw sentence? "+o);for(let a of l){let u=a+o.length-1,h=s[a],c=s[u],b=k(n,h).flatMap(g=>r[g]??[]);for(let[g,y]of f.entries())b=v({f:y,fidx:`${o}/${a}/${g}`,previousKeys:b,textToKeys:t,keyToPrev:r});if(n.furigana[c+1])for(let g of k(n,c+1))for(let y of b)p(r,g,y);let U=k(n,c),I=Object.entries(r).filter(([,g])=>U.some(y=>g.includes(y))).map(([g])=>g);for(let g of I)for(let y of b)p(r,g,y,N)}}}var N=!0;function k(n,t){if(t<0||t>=n.furigana.length)throw new Error("weird index");let r=n.furigana[t];return typeof r=="string"?[`${r}/${t}`]:[`${r.rt}/${t}`,`${r.ruby}/${t}`]}function v({f:n,fidx:t,previousKeys:r,textToKeys:e,keyToPrev:i}){if(typeof n=="string"){let o=`${n}/${t}`;p(e,n,o);for(let f of r)p(i,o,f);return[o]}let s=[];{let o=`${n.ruby}/${t}`;p(e,n.ruby,o);for(let f of r)p(i,o,f);s.push(o)}{let o=`${n.rt}/${t}`;p(e,n.rt,o);for(let f of r)p(i,o,f);s.push(o)}return s}function V(n){if(!Y(n))throw new Error("Invalid synonyms");let t={},r={},e=[];for(let[a,u]of n.furigana.entries())e=v({f:u,fidx:a,previousKeys:e,textToKeys:t,keyToPrev:r});z(n,t,r);let i=F(r),s=M(t),o=Object.keys(s),f=Object.fromEntries(o.filter(a=>!(a in r)||r[a].length===0).map(a=>[a,!0])),l=Object.fromEntries(o.filter(a=>!(a in i)||i[a].length===0).map(a=>[a,!0]));return{textToKeys:t,keyToPrev:r,keyToText:s,keyToNext:i,ancestorKeys:f,leafKeys:l}}export{P as _findGreedyPath,J as addSynonym,W as chunkInput,V as sentenceToGraph};
//# sourceMappingURL=index.min.mjs.map
